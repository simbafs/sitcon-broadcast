SITCON 2024 製播組要用的東西

# Features

-   Lighten talk 的倒數計時
-   直播右上角的字卡

# Tech

## Frontend

-   nextjs
-   tailwindcss

## Backend

-   Go
-   entgo

# TODO bugs

-   [ ] **整理文件**
-   [ ] 動態引入 session.json，有個參數可以調整 session.json 的路徑
-   [x] 更新字卡頁面樣式
-   [x] 需要一個 debug 頁面
-   [ ] 新增一個議程表頁面
-   [x] 移除 session.json 中的「休息」，動態補齊空洞
-   [x] 持久化儲存 session.json
-   [ ] 統一的設定方式（env、args...）
-   [x] 寫死時區
-   [x] time.Time 型別在 JS 接收、發送
-   [ ] Countdown 的時間對齊問題
-   [x] 統一 Go 到底怎麼把 time.Time 轉成字串
-   [x] linked list 是錯誤的，因為依照議程廳不同，前後關係也會不同
-   [ ] SSE countdown-room 頻道不要一直發更新
-   [ ] /card/admin 修改時間更新太慢
-   [x] 字卡好像不會動
-   [x] 有 broadcast 的議程要同步更新時間
-   [ ] 有些字卡字太多，會影響大小
-   [ ] API 失敗時，找個地方印出錯誤訊息（後端和前端都是）

# 反省

## API 設計

應該遵循 design first，例如 countdown，現在只是堪用，卻不正確。還有 card/session、room/countdown 等等詞彙混淆不清，這都是一開始設計不良造成的歷史債。

## SSE

當初選擇 SSE 就是因為 websocket 的重連機制很討厭，關於傳輸這方面倒是沒什麼問題，但是「誰」要收「什麼」資料卻是一個問題。現在的機制就是群發，然後收件人來撿他要的資料，而且一份資料的「標題」只能有一個。這樣雖然也是堪用，但是假設同一筆資料要發給好幾個主題（例如當更新某個議程時，應該要通知他這個議程廳、有聯播的議程廳和只監聽這個議程的所有畫面），同一筆資料發好幾次就會浪費頻寬。未來希望改成一筆資料，帶一堆「topic」。

另外關於群發，看能不能改成每個 client 設定他有興趣的「topic」，伺服器只會發送他有興趣的主題的資料給他。

大致上的流程是把資料、主題送給一個分發器，分發器檢視現在各個連線有興趣的主題，然後選出有興趣的連線並送出去。這個是要大改的地方，包含前後端都是，應該可以抽離成一個獨立函式庫。

## 超級後台

應該要有個後台可以方便的修改所有資料，不受任何檢查的，用於救急

## 時間

時間超他嗎麻煩，時區很討厭、時間表示格式也很討厭。原本我是用不帶時區資訊的 ISO 8601 格式，手動調整時區（自己 +8 mod 24)，但是 nas 上時區不知道發生什麼鬼，就是稿不定。後來改成 UTC 時區的 ISO 8601，但又發生 ent 在排序的時候有問題。最後改成 unix timestamp，既沒有時區問題（就是 +0），也沒有字串的格式問題，比較時間先後時只是間單的整數比較，甚至儲存在 DB 時佔用空間還比較小。  
處理時間時，找一個無歧異的格式是個處理時間時最最最重要的事。

# v2

-   把各議程的倒數計時和議程時間放在一起
-   按下調整議程時間的按鈕後要嘛凍結按鈕，要嘛先假裝更新
-   議程資訊每個欄位都可以修改
-   倒數計時要對齊當初按下去的時間，由前端還是後端控制還要再考慮，個人傾向於伺服器控制（也就是每秒送更新給前端）
-   完整、獨立的伺服器通知系統，看是要自己寫還是用 Socket.io 之類的
-   API 也許用 [huma](https://huma.rocks/) 之類的東西，這樣就不用花時間處理 SDK
-   修改議程時間的方式，除了移動一個時間點以外（影響前後共兩個議程），還有一個模式是增加（減少）現在議程的時間，把後面的全部往後推（往前拉）
