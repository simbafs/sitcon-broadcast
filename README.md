SITCON 2024 製播組要用的東西

# Features

-   Lighten talk 的倒數計時
-   直播右上角的字卡

# Tech

## Frontend

-   nextjs
-   tailwindcss

## Backend

-   Go
-   entgo

# TODO bugs

-   [ ] **整理文件**
-   [ ] 動態引入 session.json，有個參數可以調整 session.json 的路徑
-   [x] 更新字卡頁面樣式
-   [x] 需要一個 debug 頁面
-   [ ] 新增一個議程表頁面
-   [x] 移除 session.json 中的「休息」，動態補齊空洞
-   [x] 持久化儲存 session.json
-   [ ] 統一的設定方式（env、args...）
-   [x] 寫死時區
-   [x] time.Time 型別在 JS 接收、發送
-   [ ] Countdown 的時間對齊問題
-   [x] 統一 Go 到底怎麼把 time.Time 轉成字串
-   [x] linked list 是錯誤的，因為依照議程廳不同，前後關係也會不同
-   [ ] SSE countdown-room 頻道不要一直發更新
-   [ ] /card/admin 修改時間更新太慢
-   [x] 字卡好像不會動
-   [x] 有 broadcast 的議程要同步更新時間
-   [ ] 有些字卡字太多，會影響大小
-   [ ] API 失敗時，找個地方印出錯誤訊息（後端和前端都是）

# 反省

## 目的

這個工具究竟是要節省導播心力，讓導播不用花心力在切換字卡上，而不是又要派一個人在那邊顧字卡。我覺得第二版應該是一個白痴式的設計，只有兩個按鈕，「下一個」跟「撤銷」。再按下「下一個」按鈕之前，結束時間是 `max(現在時間, 表定結束時間)`。按下「下一個」後，結束時間就會被固定下來，且切換到下一個，同時設定下一個議程的開始時間。「撤銷」就很簡單，純粹是給導播按錯時可以 Ctrl Z。   
至於臨時修改後續議程的時間，那個應該是開一個統一的界面給其他人處理，而不是讓導播在那邊顧字卡，可能是交給議程組，或是製播組的某個統一窗口，或是乾脆不理他，反正從外面看只會有現在議程的結束時間是錯的，開始時間絕對正確。  
這樣的設計最大程度減少導播的額外負擔，甚至他拿手機就可以按那個按鈕了。  

## API 設計

應該遵循 design first，例如 countdown，現在只是堪用，卻不正確。還有 card/session、room/countdown 等等詞彙混淆不清，這都是一開始設計不良造成的歷史債。

## SSE

當初選擇 SSE 就是因為 websocket 的重連機制很討厭，關於傳輸這方面倒是沒什麼問題，但是「誰」要收「什麼」資料卻是一個問題。現在的機制就是群發，然後收件人來撿他要的資料，而且一份資料的「標題」只能有一個。這樣雖然也是堪用，但是假設同一筆資料要發給好幾個主題（例如當更新某個議程時，應該要通知他這個議程廳、有聯播的議程廳和只監聽這個議程的所有畫面），同一筆資料發好幾次就會浪費頻寬。未來希望改成一筆資料，帶一堆「topic」。

另外關於群發，看能不能改成每個 client 設定他有興趣的「topic」，伺服器只會發送他有興趣的主題的資料給他。

大致上的流程是把資料、主題送給一個分發器，分發器檢視現在各個連線有興趣的主題，然後選出有興趣的連線並送出去。這個是要大改的地方，包含前後端都是，應該可以抽離成一個獨立函式庫。

## 超級後台

應該要有個後台可以方便的修改所有資料，不受任何檢查的，用於救急

## 時間

時間超他嗎麻煩，時區很討厭、時間表示格式也很討厭。原本我是用不帶時區資訊的 ISO 8601 格式，手動調整時區（自己 +8 mod 24)，但是 nas 上時區不知道發生什麼鬼，就是稿不定。後來改成 UTC 時區的 ISO 8601，但又發生 ent 在排序的時候有問題。最後改成 unix timestamp，既沒有時區問題（就是 +0），也沒有字串的格式問題，比較時間先後時只是間單的整數比較，甚至儲存在 DB 時佔用空間還比較小。  
處理時間時，找一個無歧異的格式是個處理時間時最最最重要的事。
